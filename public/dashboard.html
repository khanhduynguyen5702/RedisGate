<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>RedisGate Dashboard - v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent: #38bdf8;
            --accent-hover: #0ea5e9;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #334155;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-email {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Sidebar */
        .layout {
            display: flex;
            min-height: calc(100vh - 73px);
        }

        .sidebar {
            width: 250px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 1.5rem 0;
        }

        .nav-item {
            padding: 0.75rem 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            color: var(--accent);
            background: rgba(56, 189, 248, 0.1);
            border-left-color: var(--accent);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-change {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--error);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        /* Buttons */
        button, .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8125rem;
        }

        /* Instance Cards */
        .instance-grid {
            display: grid;
            gap: 1.5rem;
        }

        .instance-card {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .instance-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .instance-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .instance-slug {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-family: 'Courier New', monospace;
        }

        .status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }



        .status-simulation {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .instance-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .meta-value {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }

        .instance-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }


        .table th {
            text-align: left;
            padding: 0.75rem;
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border);
        }

        .table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .table tbody tr:hover {
            background: var(--bg-primary);
        }

        /* Code Display */
        .code-block {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.8125rem;
            overflow-x: auto;
            border: 1px solid var(--border);
        }

        .copy-btn {
            float: right;
            margin-top: -0.5rem;
        }

        /* Messages */
        .message {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .message-success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .message-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .message-info {
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent);
            border: 1px solid rgba(56, 189, 248, 0.3);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .header {
                padding: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }



        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }



        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-state-title {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .empty-state-text {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }


        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }



        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .toast-message {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.25rem;
        }

        .toast-close:hover {
            color: var(--text-primary);
        }
    </style>
</head>
<body>
<!-- Toast Notifications Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Header -->
<div class="header">
    <div class="logo">üöÄ RedisGate</div>
    <div class="user-info">
        <span class="user-email" id="userEmail">Not logged in</span>
        <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
    </div>
</div>

<!-- Layout -->
<div class="layout">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="nav-item active" onclick="showPage('dashboard')">
            üìä Dashboard
        </div>
        <div class="nav-item" onclick="showPage('instances')">
            üóÑÔ∏è Redis Instances
        </div>

        <div class="nav-item" onclick="showPage('settings')">
            ‚öôÔ∏è Settings
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <h1 style="margin-bottom: 1.5rem;">Dashboard</h1>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Instances</div>
                    <div class="stat-value" id="totalInstances">0</div>
                    <div class="stat-change positive" id="instancesChange"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active API Keys</div>
                    <div class="stat-value" id="totalApiKeys">0</div>
                    <div class="stat-change positive" id="apiKeysChange"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Memory</div>
                    <div class="stat-value" id="totalMemory">0 MB</div>
                    <div class="stat-change" id="memoryChange"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Organizations</div>
                    <div class="stat-value" id="totalOrgs">1</div>
                    <div class="stat-change"></div>
                </div>
            </div>

            <!-- Quota Information -->
            <div class="card" id="quotaCard" style="margin-top: 2rem; display: none;">
                <div class="card-header">
                    <h2 class="card-title">Resource Quota</h2>
                </div>
                <div style="padding: 1.5rem;">
                    <div id="quotaWarnings" style="margin-bottom: 1rem;"></div>

                    <div style="display: grid; gap: 1.5rem;">
                        <!-- Instances Quota -->
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: var(--text-secondary);">Redis Instances</span>
                                <span id="instancesQuota" style="font-weight: 600;">0/5</span>
                            </div>
                            <div style="background: var(--bg-primary); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="instancesQuotaBar"
                                     style="background: var(--accent); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>

                        <!-- Memory Quota -->
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: var(--text-secondary);">Memory Usage</span>
                                <span id="memoryQuota" style="font-weight: 600;">0 MB / 10 GB</span>
                            </div>
                            <div style="background: var(--bg-primary); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="memoryQuotaBar"
                                     style="background: var(--accent); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>

                        <!-- API Keys Quota -->
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: var(--text-secondary);">API Keys</span>
                                <span id="apiKeysQuota" style="font-weight: 600;">0/10</span>
                            </div>
                            <div style="background: var(--bg-primary); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="apiKeysQuotaBar"
                                     style="background: var(--accent); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instances Page -->
        <div id="instances" class="page">
            <div class="card-header">
                <h1>Redis Instances</h1>
                <button class="btn btn-primary" onclick="openCreateModal()">+ Create Instance</button>
            </div>

            <div id="instancesList" class="instance-grid"></div>
        </div>



        <!-- Settings Page -->
        <div id="settings" class="page">
            <h1 style="margin-bottom: 1.5rem;">Settings</h1>

            <div class="card">
                <h2 class="card-title">Organization Settings</h2>
                <div class="form-group">
                    <label>Organization Name</label>
                    <input type="text" id="orgName" placeholder="My Organization">
                </div>
                <div class="form-group">
                    <label>Organization ID</label>
                    <input type="text" id="orgId" disabled>
                </div>
                <button class="btn btn-primary">Save Changes</button>
            </div>

            <div class="card">
                <h2 class="card-title">API Configuration</h2>
                <div class="message message-info">
                    <strong>API Base URL:</strong> <code id="apiBaseUrl"></code>
                </div>
                <div class="message message-info">
                    <strong>Your Auth Token (Dashboard):</strong>
                    <div class="code-block">
                        <button class="btn btn-sm btn-secondary copy-btn" onclick="copyToken()">Copy</button>
                        <code id="authToken"></code>
                    </div>
                </div>
                <div class="message message-success" id="apiKeySection" style="display: none;">
                    <strong>üîë Your Redis API Key (For Redis Operations):</strong>
                    <div class="code-block">
                        <button class="btn btn-sm btn-success copy-btn" onclick="copyApiKey()">Copy</button>
                        <code id="redisApiKey"></code>
                    </div>
                    <small style="color: #666; display: block; margin-top: 0.5rem;">
                        Use this API key to connect to Redis instances via HTTP API
                    </small>
                </div>
                <div class="message message-warning" id="noApiKeySection" style="display: none;">
                    <strong>‚ö†Ô∏è No Redis API Key Found</strong>
                    <p>You need an organization and API key to use Redis instances.</p>
                    <button class="btn btn-primary" onclick="generateApiKey()">Generate API Key</button>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">üìñ How to Use Redis API</h2>
                <div style="background: #0f172a; padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                    <h3 style="color: var(--accent); margin-bottom: 1rem;">Example API Calls</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        Use your API key to perform Redis operations via HTTP:
                    </p>

                    <div style="margin-bottom: 1.5rem;">
                        <strong style="color: var(--success);">1. PING (Test Connection)</strong>
                        <pre style="background: #1e293b; padding: 1rem; border-radius: 4px; overflow-x: auto; margin-top: 0.5rem;"><code>GET /redis/{instance_id}/ping?_token=YOUR_API_KEY</code></pre>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <strong style="color: var(--success);">2. SET Key</strong>
                        <pre style="background: #1e293b; padding: 1rem; border-radius: 4px; overflow-x: auto; margin-top: 0.5rem;"><code>GET /redis/{instance_id}/set/mykey/myvalue?_token=YOUR_API_KEY</code></pre>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <strong style="color: var(--success);">3. GET Key</strong>
                        <pre style="background: #1e293b; padding: 1rem; border-radius: 4px; overflow-x: auto; margin-top: 0.5rem;"><code>GET /redis/{instance_id}/get/mykey?_token=YOUR_API_KEY</code></pre>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <strong style="color: var(--success);">4. Using with curl</strong>
                        <pre style="background: #1e293b; padding: 1rem; border-radius: 4px; overflow-x: auto; margin-top: 0.5rem;"><code>curl -H "Authorization: Bearer YOUR_API_KEY" \\
     http://localhost:3000/redis/{instance_id}/ping</code></pre>
                    </div>

                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 1rem;">
                        üí° Replace <code>{instance_id}</code> with your actual instance ID from the Instances page.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Instance Modal -->
<div id="createModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Create Redis Instance</h2>
            <button class="close-btn" onclick="closeCreateModal()">&times;</button>
        </div>

        <div class="form-group">
            <label>Instance Name *</label>
            <input type="text" id="instanceName" placeholder="my-redis-instance">
        </div>

        <div class="form-group">
            <label>Memory Limit *</label>
            <select id="memoryLimit">
                <option value="268435456">256 MB</option>
                <option value="536870912" selected>512 MB</option>
                <option value="1073741824">1 GB</option>
                <option value="2147483648">2 GB</option>
            </select>
        </div>

        <div class="form-group">
            <label>Redis Version</label>
            <select id="redisVersion">
                <option value="6.2">6.2</option>
                <option value="7.0" selected>7.0</option>
                <option value="7.2">7.2</option>
            </select>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" id="persistenceEnabled" checked>
                Enable Persistence
            </label>
        </div>

        <div id="createInstanceStatus"></div>

        <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="createInstance()">Create Instance</button>
            <button class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Create API Key Modal -->
<div id="createApiKeyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Create API Key</h2>
            <button class="close-btn" onclick="closeCreateApiKeyModal()">&times;</button>
        </div>

        <div class="form-group">
            <label>Key Name *</label>
            <input type="text" id="apiKeyName" placeholder="Production API Key">
        </div>

        <div class="form-group">
            <label>Scopes</label>
            <select id="apiKeyScopes" multiple>
                <option value="read" selected>Read</option>
                <option value="write" selected>Write</option>
                <option value="delete">Delete</option>
            </select>
        </div>

        <div id="createApiKeyStatus"></div>

        <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="createApiKey()">Create Key</button>
            <button class="btn btn-secondary" onclick="closeCreateApiKeyModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
    console.log('üöÄ Dashboard v2.0 - Loaded at:', new Date().toISOString());
    console.log('‚úÖ Instance rendering fix applied');

    const API_BASE = window.location.origin;
    let token = localStorage.getItem('authToken');
    let orgId = localStorage.getItem('organizationId');
    let currentUser = null;

    console.log('=== Dashboard Initialization ===');
    console.log('API_BASE:', API_BASE);
    console.log('Token exists:', !!token);
    console.log('Token (first 50 chars):', token ? token.substring(0, 50) + '...' : 'null');
    console.log('Organization ID:', orgId);

    // Test token immediately
    if (token) {
        console.log('üîç Testing token validity...');
        fetch(`${API_BASE}/auth/me`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
        .then(res => {
            console.log('Token test response status:', res.status);
            if (res.status === 401) {
                console.error('‚ùå Token is INVALID! Status: 401');
                console.log('üîÑ Clearing invalid token and redirecting to login...');
                localStorage.removeItem('authToken');
                localStorage.removeItem('organizationId');
                alert('‚ö†Ô∏è Your session has expired or is invalid.\n\nPlease login again.\n\nClick OK to go to login page.');
                window.location.href = '/';
                return null;
            }
            return res.json();
        })
        .then(data => {
            if (data) {
                console.log('‚úÖ Token is VALID! User:', data);
            }
        })
        .catch(err => {
            console.error('‚ùå Token test failed:', err);
        });
    }

    // Initialize
    if (!token) {
        console.log('No token found - redirecting to login');
        window.location.href = '/login.html';
    } else {
        console.log('Token found - initializing dashboard');
        init();
    }

    async function init() {
        console.log('Init function started');
        await loadCurrentUser();

        // Ensure user has an organization
        if (!orgId || orgId === 'null' || orgId === 'undefined') {
            console.log('No organization ID found - checking for existing orgs');
            await ensureOrganization();
        }

        if (orgId && orgId !== 'null' && orgId !== 'undefined') {
            await loadDashboardData();
        } else {
            console.error('Failed to get organization ID');
            showMessage('error', 'Please create an organization first');
        }

        showPage('dashboard');
        console.log('Init function completed');
    }

    // Ensure user has an organization - create one if needed
    async function ensureOrganization() {
        try {
            // First, try to list existing organizations
            const listRes = await fetch(`${API_BASE}/api/organizations`, {
                headers: {'Authorization': `Bearer ${token}`}
            });

            if (listRes.ok) {
                const listData = await listRes.json();
                console.log('Existing organizations:', listData);

                if (listData.success && listData.data && listData.data.data && listData.data.data.length > 0) {
                    // Use first organization
                    const firstOrg = listData.data.data[0];
                    orgId = firstOrg.id;
                    localStorage.setItem('organizationId', orgId);
                    console.log('Using existing organization:', orgId);
                    return;
                }
            }

            // No organizations found - create default one
            console.log('No organizations found - creating default organization');
            const createRes = await fetch(`${API_BASE}/api/organizations`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: `${currentUser.email}'s Organization`,
                    slug: `org-${Date.now()}`,
                    description: 'Default organization'
                })
            });

            if (createRes.ok) {
                const createData = await createRes.json();
                console.log('Created new organization:', createData);

                if (createData.success && createData.data) {
                    orgId = createData.data.id;
                    localStorage.setItem('organizationId', orgId);
                    console.log('Organization created successfully:', orgId);
                }
            } else {
                console.error('Failed to create organization:', await createRes.text());
            }
        } catch (err) {
            console.error('Error ensuring organization:', err);
        }
    }

    async function loadCurrentUser() {
        try {
            const res = await fetch(`${API_BASE}/auth/me`, {
                headers: {'Authorization': `Bearer ${token}`}
            });

            if (res.ok) {
                const data = await res.json();
                currentUser = data.data;
                document.getElementById('userEmail').textContent = currentUser.email;
            } else {
                logout();
            }
        } catch (err) {
            console.error('Failed to load user:', err);
        }
    }

    async function loadDashboardData() {
        await Promise.all([
            loadInstances(),
            loadApiKeys(),
            loadOrganization(),
            loadQuota()
        ]);
        updateStats();
    }

    let instances = [];
    let apiKeys = [];
    let organization = null;
    let quotaInfo = null;

    async function loadInstances() {
        if (!orgId || orgId === 'null' || orgId === 'undefined') {
            console.error('Cannot load instances: no organization ID');
            instances = [];
            renderInstances();
            return;
        }

        console.log('Loading instances for org:', orgId);

        try {
            const res = await fetch(`${API_BASE}/api/organizations/${orgId}/redis-instances`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });

            console.log('Response status:', res.status);

            if (res.status === 401) {
                console.error('‚ö†Ô∏è 401 Unauthorized - Token is invalid or expired');
                showMessage('error', 'Session expired. Please login again.');
                localStorage.removeItem('authToken');
                localStorage.removeItem('organizationId');
                setTimeout(() => {
                    window.location.href = '/';
                }, 1500);
                return;
            }

            const data = await res.json();
            console.log('Response data:', data);

            if (data.success && data.data && data.data.items) {
                // ‚úÖ FIX: Assign directly and render immediately
                instances = data.data.items;
                console.log('‚úÖ Loaded instances:', instances.length, instances);
                renderInstances();
            } else {
                console.error('No instances in response');
                instances = [];
                renderInstances();
            }
        } catch (err) {
            console.error('Failed to load instances:', err);
            showMessage('error', 'Failed to load instances');
            instances = [];
            renderInstances();
        }
    }


    async function loadApiKeys() {
        try {
            const res = await fetch(`${API_BASE}/api/organizations/${orgId}/api-keys`, {
                headers: {'Authorization': `Bearer ${token}`}
            });

            const data = await res.json();
            if (data.success && data.data) {
                apiKeys = Array.isArray(data.data) ? data.data : (data.data.data || []);
                renderApiKeys();
            }
        } catch (err) {
            console.error('Failed to load API keys:', err);
        }
    }

    async function loadOrganization() {
        try {
            const res = await fetch(`${API_BASE}/api/organizations/${orgId}`, {
                headers: {'Authorization': `Bearer ${token}`}
            });

            const data = await res.json();
            if (data.success && data.data) {
                organization = data.data;
                document.getElementById('orgName').value = organization.name;
                document.getElementById('orgId').value = organization.id;
            }
        } catch (err) {
            console.error('Failed to load organization:', err);
        }
    }

    async function loadQuota() {
        try {
            const res = await fetch(`${API_BASE}/api/organizations/${orgId}/quota`, {
                headers: {'Authorization': `Bearer ${token}`}
            });

            const data = await res.json();
            console.log('Quota data:', data);

            if (data.success && data.data) {
                quotaInfo = data.data.quota;
                updateQuotaDisplay();

                // Show warnings if any
                if (data.data.warnings && data.data.warnings.length > 0) {
                    showQuotaWarnings(data.data.warnings);
                }
            }
        } catch (err) {
            console.error('Failed to load quota:', err);
        }
    }

    function updateQuotaDisplay() {
        if (!quotaInfo) return;

        // Show quota card
        document.getElementById('quotaCard').style.display = 'block';

        // Update instances quota
        document.getElementById('instancesQuota').textContent =
            `${quotaInfo.current_instances}/${quotaInfo.max_instances}`;
        const instancesPercent = quotaInfo.instances_percentage;
        const instancesBar = document.getElementById('instancesQuotaBar');
        instancesBar.style.width = `${instancesPercent}%`;
        instancesBar.style.background = instancesPercent >= 90 ? 'var(--error)' :
            instancesPercent >= 75 ? 'var(--warning)' : 'var(--accent)';

        // Update memory quota
        const memoryUsedGB = (quotaInfo.current_memory_mb / 1024).toFixed(2);
        document.getElementById('memoryQuota').textContent =
            `${memoryUsedGB} GB / ${quotaInfo.max_memory_gb} GB`;
        const memoryPercent = quotaInfo.memory_percentage;
        const memoryBar = document.getElementById('memoryQuotaBar');
        memoryBar.style.width = `${memoryPercent}%`;
        memoryBar.style.background = memoryPercent >= 90 ? 'var(--error)' :
            memoryPercent >= 75 ? 'var(--warning)' : 'var(--accent)';

        // Update API keys quota
        document.getElementById('apiKeysQuota').textContent =
            `${quotaInfo.current_api_keys}/${quotaInfo.max_api_keys}`;
        const apiKeysPercent = (quotaInfo.current_api_keys / quotaInfo.max_api_keys) * 100;
        const apiKeysBar = document.getElementById('apiKeysQuotaBar');
        apiKeysBar.style.width = `${apiKeysPercent}%`;
        apiKeysBar.style.background = apiKeysPercent >= 90 ? 'var(--error)' :
            apiKeysPercent >= 75 ? 'var(--warning)' : 'var(--accent)';
    }

    function showQuotaWarnings(warnings) {
        const container = document.getElementById('quotaWarnings');
        container.innerHTML = warnings.map(warning => `
                <div style="background: rgba(245, 158, 11, 0.1); border-left: 3px solid var(--warning); padding: 1rem; border-radius: 4px; margin-bottom: 0.5rem;">
                    <strong>‚ö†Ô∏è Warning:</strong> ${warning}
                </div>
            `).join('');
    }

    function updateStats() {
        document.getElementById('totalInstances').textContent = instances.length;
        document.getElementById('totalApiKeys').textContent = apiKeys.length;

        const totalMemory = instances.reduce((sum, inst) => sum + (inst.max_memory || 0), 0);
        document.getElementById('totalMemory').textContent = formatBytes(totalMemory);

        document.getElementById('apiBaseUrl').textContent = API_BASE;
        document.getElementById('authToken').textContent = token.substring(0, 50) + '...';
    }

    function renderInstances() {
        console.log('Rendering instances. Count:', instances.length);
        console.log('Instances data:', instances);

        const container = document.getElementById('instancesList');
        const recentContainer = document.getElementById('recentInstances');

        if (!instances || instances.length === 0) {
            console.log('No instances to render - showing empty state');
            const emptyHtml = `
            <div class="empty-state">
                <div class="empty-state-icon">üóÑÔ∏è</div>
                <div class="empty-state-title">No Redis Instances</div>
                <div class="empty-state-text">Create your first Redis instance to get started</div>
                <button class="btn btn-primary" onclick="openCreateModal()">+ Create Instance</button>
            </div>
        `;
            if (container) container.innerHTML = emptyHtml;
            if (recentContainer) recentContainer.innerHTML = emptyHtml;
            return;
        }

        console.log('‚úÖ Rendering', instances.length, 'instances');

        const html = instances.map(inst => `
            <div class="instance-card">
                <div class="instance-header">
                    <div>
                        <div class="instance-name">${escapeHtml(inst.name)}</div>
                        <div class="instance-slug">${escapeHtml(inst.slug)}</div>
                    </div>
                    <span class="status-badge status-simulation">Simulation</span>
                </div>

                <div class="instance-meta">
                    <div class="meta-item">
                        <div class="meta-label">Memory Limit</div>
                        <div class="meta-value">${formatBytes(inst.max_memory)}</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Redis Version</div>
                        <div class="meta-value">${inst.redis_version || '7.0'}</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Created</div>
                        <div class="meta-value">${formatDate(inst.created_at)}</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Instance ID</div>
                        <div class="meta-value">${inst.id.substring(0, 50)}</div>
                    </div>
                </div>

                <div class="instance-actions">
                    <button class="btn btn-sm btn-danger" onclick="deleteInstance('${inst.id}')">Delete</button>
                </div>
            </div>
        `).join('');

        console.log('Generated HTML. Length:', html.length);

        if (container) {
            container.innerHTML = html;
            console.log('Updated instancesList container');
        }
        if (recentContainer) {
            recentContainer.innerHTML = html;
            console.log('Updated recentInstances container');
        }
    }


    function renderApiKeys() {
        const tbody = document.getElementById('apiKeysList');

        if (apiKeys.length === 0) {
            tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            No API keys found. Create one to get started.
                        </td>
                    </tr>
                `;
            return;
        }

        tbody.innerHTML = apiKeys.map(key => `
                <tr>
                    <td>${escapeHtml(key.name)}</td>
                    <td><code>${escapeHtml(key.key_prefix)}</code></td>
                    <td>${key.scopes ? key.scopes.join(', ') : 'N/A'}</td>
                    <td>${formatDate(key.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteApiKey('${key.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
    }

    // Navigation
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

        document.getElementById(pageId).classList.add('active');
        event?.target?.classList.add('active');

        if (pageId === 'instances') loadInstances();
        if (pageId === 'api-keys') loadApiKeys();
        if (pageId === 'settings') loadSettings();
    }

    // Load Settings
    function loadSettings() {
        // Display API Base URL
        document.getElementById('apiBaseUrl').textContent = API_BASE;

        // Display Auth Token
        document.getElementById('authToken').textContent = token ? token.substring(0, 80) + '...' : 'Not found';

        // Display API Key for Redis operations
        const apiKey = localStorage.getItem('apiKey');
        const apiKeySection = document.getElementById('apiKeySection');
        const noApiKeySection = document.getElementById('noApiKeySection');

        if (apiKey && apiKey !== 'null') {
            apiKeySection.style.display = 'block';
            noApiKeySection.style.display = 'none';
            document.getElementById('redisApiKey').textContent = apiKey.substring(0, 80) + '...';
            console.log('‚úÖ Redis API Key loaded');
        } else {
            apiKeySection.style.display = 'none';
            noApiKeySection.style.display = 'block';
            console.log('‚ö†Ô∏è No Redis API Key found');
        }

        // Display Organization info
        if (organization) {
            document.getElementById('orgName').value = organization.name || '';
            document.getElementById('orgId').value = organization.id || orgId || '';
        } else {
            document.getElementById('orgId').value = orgId || '';
        }
    }

    // Modals
    function openCreateModal() {
        document.getElementById('createModal').classList.add('active');
    }

    function closeCreateModal() {
        document.getElementById('createModal').classList.remove('active');
        document.getElementById('instanceName').value = '';
        document.getElementById('createInstanceStatus').innerHTML = '';
    }

    function openCreateApiKeyModal() {
        document.getElementById('createApiKeyModal').classList.add('active');
    }

    function closeCreateApiKeyModal() {
        document.getElementById('createApiKeyModal').classList.remove('active');
        document.getElementById('apiKeyName').value = '';
        document.getElementById('createApiKeyStatus').innerHTML = '';
    }

    // Create Instance
    async function createInstance() {
        const name = document.getElementById('instanceName').value.trim();
        const memory = document.getElementById('memoryLimit').value;
        const version = document.getElementById('redisVersion').value;
        const persistence = document.getElementById('persistenceEnabled').checked;
        const status = document.getElementById('createInstanceStatus');

        if (!name) {
            status.innerHTML = '<div class="message message-error">Instance name is required</div>';
            return;
        }

        status.innerHTML = '<div class="message message-info">Creating instance...</div>';

        const slug = name.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '')
            .substring(0, 50) + '-' + Date.now().toString().substring(-6);

        try {
            const res = await fetch(`${API_BASE}/api/organizations/${orgId}/redis-instances`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    name,
                    slug,
                    organization_id: orgId,
                    max_memory: parseInt(memory),
                    redis_version: version,
                    persistence_enabled: persistence,
                    backup_enabled: false
                })
            });

            const data = await res.json();

            if (res.ok && data.success) {
                showMessage('success', 'Redis instance created successfully!', 'Instance Created');
                status.innerHTML = '<div class="message message-success">‚úì Instance created successfully!</div>';
                setTimeout(() => {
                    closeCreateModal();
                    loadInstances();
                    loadQuota(); // Refresh quota information
                }, 1500);
            } else {
                const errorMsg = data.message || 'Failed to create instance';
                showMessage('error', errorMsg, 'Creation Failed');
                status.innerHTML = `<div class="message message-error">‚úó ${errorMsg}</div>`;
            }
        } catch (err) {
            showMessage('error', err.message, 'Error');
            status.innerHTML = `<div class="message message-error">‚úó Error: ${err.message}</div>`;
        }
    }

    // Create API Key
    async function createApiKey() {
        const name = document.getElementById('apiKeyName').value.trim();
        const scopesSelect = document.getElementById('apiKeyScopes');
        const scopes = Array.from(scopesSelect.selectedOptions).map(o => o.value);
        const status = document.getElementById('createApiKeyStatus');

        if (!name) {
            status.innerHTML = '<div class="message message-error">API key name is required</div>';
            return;
        }

        status.innerHTML = '<div class="message message-info">Creating API key...</div>';

        try {
            const res = await fetch(`${API_BASE}/api/organizations/${orgId}/api-keys`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    name,
                    organization_id: orgId,
                    scopes: scopes.length > 0 ? scopes : ['read', 'write']
                })
            });

            const data = await res.json();

            if (res.ok && data.success) {
                status.innerHTML = `
                        <div class="message message-success">
                            ‚úì API Key created successfully!<br>
                            <strong>Key:</strong> <code>${data.data.key_token}</code>
                            <button class="btn btn-sm btn-secondary" onclick="navigator.clipboard.writeText('${data.data.key_token}')">Copy</button>
                        </div>
                    `;
                setTimeout(() => {
                    closeCreateApiKeyModal();
                    loadApiKeys();
                    loadQuota(); // Refresh quota information
                }, 3000);
            } else {
                status.innerHTML = `<div class="message message-error">‚úó ${data.message || 'Failed to create API key'}</div>`;
            }
        } catch (err) {
            status.innerHTML = `<div class="message message-error">‚úó Error: ${err.message}</div>`;
        }
    }

    // Redis Commands
    async function testPing(instanceId) {
        const output = document.getElementById(`output-${instanceId}`);
        output.textContent = 'Executing PING...';

        try {
            const res = await fetch(`${API_BASE}/redis/${instanceId}/ping`, {
                headers: {'Authorization': `Bearer ${token}`}
            });
            const data = await res.json();
            output.textContent = JSON.stringify(data, null, 2);
        } catch (err) {
            output.textContent = `Error: ${err.message}`;
        }
    }

    async function testSet(instanceId) {
        const key = document.getElementById(`key-${instanceId}`).value;
        const value = document.getElementById(`value-${instanceId}`).value;
        const output = document.getElementById(`output-${instanceId}`);

        if (!key || !value) {
            output.textContent = 'Error: Both key and value are required for SET';
            return;
        }

        output.textContent = `Executing SET ${key} ${value}...`;

        try {
            const res = await fetch(`${API_BASE}/redis/${instanceId}/set/${key}/${value}`, {
                headers: {'Authorization': `Bearer ${token}`}
            });
            const data = await res.json();
            output.textContent = JSON.stringify(data, null, 2);
        } catch (err) {
            output.textContent = `Error: ${err.message}`;
        }
    }

    async function testGet(instanceId) {
        const key = document.getElementById(`key-${instanceId}`).value;
        const output = document.getElementById(`output-${instanceId}`);

        if (!key) {
            output.textContent = 'Error: Key is required for GET';
            return;
        }

        output.textContent = `Executing GET ${key}...`;

        try {
            const res = await fetch(`${API_BASE}/redis/${instanceId}/get/${key}`, {
                headers: {'Authorization': `Bearer ${token}`}
            });
            const data = await res.json();
            output.textContent = JSON.stringify(data, null, 2);
        } catch (err) {
            output.textContent = `Error: ${err.message}`;
        }
    }

    // Delete Instance
    async function deleteInstance(id) {
        if (!confirm('Are you sure you want to delete this instance? This action cannot be undone.')) {
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/api/organizations/${orgId}/redis-instances/${id}`, {
                method: 'DELETE',
                headers: {'Authorization': `Bearer ${token}`}
            });

            if (res.ok) {
                loadInstances();
                loadQuota(); // Refresh quota information
            } else {
                const data = await res.json();
                alert(`Failed to delete: ${data.message}`);
            }
        } catch (err) {
            alert(`Error: ${err.message}`);
        }
    }

    // Delete API Key
    async function deleteApiKey(id) {
        if (!confirm('Are you sure you want to delete this API key?')) {
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/api/organizations/${orgId}/api-keys/${id}`, {
                method: 'DELETE',
                headers: {'Authorization': `Bearer ${token}`}
            });

            if (res.ok) {
                loadApiKeys();
                loadQuota(); // Refresh quota information
            } else {
                const data = await res.json();
                alert(`Failed to delete: ${data.message}`);
            }
        } catch (err) {
            alert(`Error: ${err.message}`);
        }
    }

    // Toast Notification System
    function showMessage(type, message, title = null, duration = 5000) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;

        const icons = {
            success: '‚úì',
            error: '‚úó',
            warning: '‚ö†',
            info: '‚Ñπ'
        };

        const titles = {
            success: title || 'Success',
            error: title || 'Error',
            warning: title || 'Warning',
            info: title || 'Info'
        };

        toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

        container.appendChild(toast);

        // Auto remove after duration
        if (duration > 0) {
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
    }

    // Logout
    function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('organizationId');
        localStorage.removeItem('apiKey');
        window.location.href = '/';
    }

    // Utilities
    function formatBytes(bytes) {
        if (!bytes) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i)) + ' ' + sizes[i];
    }

    function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function copyToken() {
        navigator.clipboard.writeText(token);
        alert('Token copied to clipboard!');
    }

    function copyApiKey() {
        const apiKey = localStorage.getItem('apiKey');
        if (apiKey) {
            navigator.clipboard.writeText(apiKey);
            alert('‚úÖ Redis API Key copied to clipboard!');
        } else {
            alert('‚ùå No API key found');
        }
    }

    async function generateApiKey() {
        if (!orgId || orgId === 'null') {
            showMessage('error', 'Please create an organization first');
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/api/organizations/${orgId}/api-keys`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: 'Redis API Key - Auto Generated',
                    organization_id: orgId,
                    scopes: ['*']
                })
            });

            if (res.ok) {
                const data = await res.json();
                if (data.success && data.data) {
                    // The API returns the key_token in the response
                    const newApiKey = data.data.key_token;
                    localStorage.setItem('apiKey', newApiKey);
                    showMessage('success', '‚úÖ API Key generated successfully!');
                    loadSettings(); // Reload settings to show the new key
                }
            } else {
                const error = await res.json();
                showMessage('error', 'Failed to generate API key: ' + (error.message || 'Unknown error'));
            }
        } catch (err) {
            console.error('Error generating API key:', err);
            showMessage('error', 'Network error generating API key');
        }
    }

    function viewInstance(id) {
        alert('Instance details: ' + id);
    }
</script>
</body>
</html>

